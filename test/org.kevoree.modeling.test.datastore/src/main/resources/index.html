<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <!--<script src="./java.js"></script>-->
    <script src="./org.kevoree.modeling.test.datastore-all.js"></script>
    <script src="./org.kevoree.modeling.database.websocket.WebSocket.js"></script>
</head>
<body>

<button id="addNewShapeButton">AddNewShape</button>


<script>

    var dataBaseConnection = new org.kevoree.modeling.database.websocket.WebSocketDataBaseClient("ws://localhost:23664");
    var broker = new org.kevoree.modeling.database.websocket.WebSocketBrokerClient("ws://localhost:23665");
    var geometryModel  = new geometry.GeometryModel();
    //broker.setMetaModel(geometryUniverse.metaModel());
    geometryModel.setDataBase(dataBaseConnection);
    geometryModel.setEventBroker(broker);

    geometryModel.connect(function(err){
        if(err == null) {
            console.log("Looking for the dimension");
            var dimension = geometryModel.universe(0);
            var view = dimension.time(0);
            view.select("/", function(results){
                if(results === undefined || results.length == 0) {
                    console.error("No root found.", results)
                } else {
                    var lib = results[0];
                    lib.getShapes(function(shapes){
                        if(shapes != null) {
                            for(var i in shapes) {
                                addShapeToDisplay(shapes[i]);
                            }
                        } else {
                            console.error("No shapes found");
                        }});

                    dimension.listen(function(event){
                        if(event.actionType() == org.kevoree.modeling.api.KActionType.ADD && event.metaClass() == lib.metaClass() && event.metaElement() == lib.metaClass().metaReference("shapes")) {
                            console.log(event.value());
                            addShapeToDisplay(event.value());
                        }
                    });
                    console.log("Yeah go ahead !")
                }
            });
        } else {
            console.log(err);
            err.printStackTrace();
        }
    });

    function addShapeToDisplay(shape) {
        $('<div id="'+shape.getName()+'" style="height:50px;width:50px;display: inline-block; margin: 10px;background-color: '+shape.getColor()+';"></div>').appendTo($('body'));
        shape.listen(function(event){
            if(event.metaElement() == shape.metaClass().metaAttribute("color")) {
                $('div#' + shape.getName()).css('background-color', event.value());
            }
        });
    }

    $('#addNewShapeButton').on('click', addNewShape);

    function addNewShape() {
        var dimension = geometryModel.universe(0);
        var view = dimension.time(0);
        view.select("/", function (results) {
            if (results === undefined || results.length == 0) {
                console.error("No root found.", results)
            } else {
                var lib = results[0];
                var index = lib.sizeOfShapes();
                index = index +1;
                var newShape = view.createShape();
                newShape.setName("Shape"+index);
                newShape.setColor("grey");
                lib.addShapes(newShape);
                dimension.save(function(err){if(err){console.error(err);}});
            }
        });
    }

</script>


</body>
</html>